<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ODLICZANIE DO PAPIEŻOWEJ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background-color: #1e90ff;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      letter-spacing: 2px;
    }

    #countdown {
      font-size: 4rem;
      font-weight: bold;
      margin-bottom: 30px;
    }

    /* Wrapper na player audio – pokazujemy/ukrywamy */
    #playerWrapper {
      display: none;           /* domyślnie ukryty */
      margin-bottom: 20px;
    }

    audio {
      width: 320px;
    }

    #testButton {
      background: #ffffff;
      color: #000000;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }

    #testButton:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .controls {
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <h1>ODLICZANIE DO PAPIEŻOWEJ</h1>
  <div id="countdown">00:00:00</div>

  <!-- Player MP3 (pokazywany tylko w oknie 21:37–21:39 i podczas testu) -->
  <div id="playerWrapper">
    <audio id="audioPlayer" src="papiezowa.mp3" controls></audio>
  </div>

  <button id="testButton">TESTUJ PAPIEŻOWĄ</button>

  <div class="controls">
    <label>Głośność: <span id="volumeValue">100</span>%</label><br>
    <input type="range" id="volumeRange" min="0" max="100" value="100" />
  </div>

  <script>
    // ------------ USTAWIENIA CZASU ------------

    const TARGET_HOUR = 21;
    const TARGET_MINUTE = 37;
    const TARGET_SECOND = 0;

    // Okno 21:37:00 – 21:39:00
    const WINDOW_START_SECONDS = 21 * 3600 + 37 * 60 + 0;
    const WINDOW_END_SECONDS   = 21 * 3600 + 39 * 60 + 0;

    const DEFAULT_BG = "#1e90ff";

    // ------------ ELEMENTY DOM ------------

    const countdownEl   = document.getElementById("countdown");
    const playerWrapper = document.getElementById("playerWrapper");
    const audio         = document.getElementById("audioPlayer");
    const testBtn       = document.getElementById("testButton");
    const volRange      = document.getElementById("volumeRange");
    const volValue      = document.getElementById("volumeValue");

    // ------------ STANY ------------

    let flashingTimeout = null;
    let testMode = false;
    let cooldown = false;
    let windowActive = false;

    // ------------ GŁOŚNOŚĆ ------------

    // HTML audio.volume jest 0.0–1.0
    volRange.addEventListener("input", () => {
      const vol = parseInt(volRange.value, 10);
      volValue.textContent = vol;
      audio.volume = vol / 100;
    });

    // Ustaw startową głośność
    audio.volume = 1.0;

    // ------------ ODLICZANIE DO 21:37 ------------

    function getNextTargetTime() {
      const now = new Date();
      const t = new Date();
      t.setHours(TARGET_HOUR, TARGET_MINUTE, TARGET_SECOND, 0);
      if (t <= now) t.setDate(t.getDate() + 1); // jeśli dziś już minęło
      return t;
    }

    let targetTime = getNextTargetTime();

    function updateCountdown() {
      const now = new Date();
      let diff = targetTime - now;

      if (diff <= 0) {
        targetTime = getNextTargetTime();
        diff = targetTime - now;
      }

      const totalSeconds = Math.floor(diff / 1000);
      const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const s = String(totalSeconds % 60).padStart(2, "0");

      countdownEl.textContent = `${h}:${m}:${s}`;
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();

    // ------------ MIGANIE TŁA ------------

    function startFlash() {
      stopFlash();
      function flash() {
        document.body.style.backgroundColor =
          `rgb(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255})`;
        flashingTimeout = setTimeout(flash, 100 + Math.random() * 200);
      }
      flash();
    }

    function stopFlash() {
      if (flashingTimeout !== null) {
        clearTimeout(flashingTimeout);
        flashingTimeout = null;
      }
      document.body.style.backgroundColor = DEFAULT_BG;
    }

    // ------------ POKAZYWANIE / CHOWANIE PLAYERA ------------

    function showPlayer() {
      playerWrapper.style.display = "block";
    }

    function hidePlayer() {
      playerWrapper.style.display = "none";
    }

    // ------------ COOLDOWN PO TEŚCIE ------------

    function startCooldown() {
      cooldown = true;
      let t = 20;
      testBtn.disabled = true;
      testBtn.textContent = `COOLDOWN ${t}s`;

      const cd = setInterval(() => {
        t--;
        if (t <= 0) {
          clearInterval(cd);
          cooldown = false;
          testBtn.disabled = false;
          testBtn.textContent = "TESTUJ PAPIEŻOWĄ";
        } else {
          testBtn.textContent = `COOLDOWN ${t}s`;
        }
      }, 1000);
    }

    // ------------ TESTUJ PAPIEŻOWĄ (max 5s) ------------

    testBtn.addEventListener("click", () => {
      if (cooldown) return;

      testMode = true;
      testBtn.textContent = "TEST (5s)";
      showPlayer();
      startFlash();

      try { audio.currentTime = 0; } catch (e) {}
      audio.play().catch(() => {
        // jeśli przeglądarka zablokuje, nic nie zrobimy, ale test i tak miga
      });

      setTimeout(() => {
        testMode = false;
        audio.pause();
        stopFlash();
        // jeśli nie jesteśmy w właściwym oknie, chowamy player
        const now = new Date();
        const s = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        if (!(s >= WINDOW_START_SECONDS && s < WINDOW_END_SECONDS)) {
          hidePlayer();
        }
        startCooldown();
      }, 5000);
    });

    // ------------ AUTO 21:37–21:39 ------------

    setInterval(() => {
      if (testMode) return; // w trakcie testu nie ruszamy

      const now = new Date();
      const secondsNow = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      const inWindow = secondsNow >= WINDOW_START_SECONDS && secondsNow < WINDOW_END_SECONDS;

      if (inWindow && !windowActive) {
        // wchodzimy w okno
        windowActive = true;
        showPlayer();
        startFlash();
        audio.play().catch(() => {
          // przeglądarka może zablokować autoplay, ale player będzie widoczny
        });
      } else if (!inWindow && windowActive) {
        // wychodzimy z okna
        windowActive = false;
        audio.pause();
        stopFlash();
        hidePlayer();
      }
    }, 500);
  </script>
</body>
</html>
